services:
  neo4j:
    image: neo4j:5.26.16
    container_name: graphiti-search-bot-neo4j
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-password123}
      # APOC/GDSプラグイン（graphiti-core互換性優先）
      NEO4JLABS_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"
      # メモリ設定
      NEO4J_dbms_memory_heap_initial__size: ${NEO4J_HEAP_INITIAL_SIZE:-512M}
      NEO4J_dbms_memory_heap_max__size: ${NEO4J_HEAP_MAX_SIZE:-1G}
      NEO4J_dbms_memory_pagecache_size: ${NEO4J_PAGECACHE_SIZE:-512M}
    ports:
      - "${NEO4J_HTTP_PORT:-20474}:7474" # HTTP
      - "${NEO4J_BOLT_PORT:-20687}:7687" # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: [ "CMD-SHELL", "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-password123} 'RETURN 1'" ]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks:
      - graphiti-network

  graphiti-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: graphiti-search-bot-mcp
    ports:
      - "${GRAPHITI_MCP_PORT:-30547}:8001"
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password123}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      GRAPHITI_TELEMETRY_ENABLED: ${GRAPHITI_TELEMETRY_ENABLED:-false}
      PYTHONUNBUFFERED: "1"
      # Proxy configuration
      PROXY_USE: ${PROXY_USE:-FALSE}
      OPENAI_PROXY: ${OPENAI_PROXY:-}
      OPENAI_PROXY_USERNAME: ${OPENAI_PROXY_USERNAME:-}
      OPENAI_PROXY_PASSWORD: ${OPENAI_PROXY_PASSWORD:-}
      NO_PROXY: ${NO_PROXY:-localhost,127.0.0.1}
    depends_on:
      neo4j:
        condition: service_healthy
    volumes:
      - ./server/src:/app/src
      - ./server/scripts:/app/scripts
      - ./server/slack_data:/app/slack_data
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - graphiti-network

  search-bot-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: search-bot-backend
    ports:
      - "${BACKEND_PORT:-20001}:20001"
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password123}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      BACKEND_PORT: "20001"
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:20002,http://localhost:3000,http://localhost:5173}
      # Proxy configuration
      PROXY_USE: ${PROXY_USE:-FALSE}
      OPENAI_PROXY: ${OPENAI_PROXY:-}
      OPENAI_PROXY_USERNAME: ${OPENAI_PROXY_USERNAME:-}
      OPENAI_PROXY_PASSWORD: ${OPENAI_PROXY_PASSWORD:-}
      NO_PROXY: ${NO_PROXY:-localhost,127.0.0.1}
    depends_on:
      neo4j:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:20001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - graphiti-network

  search-bot-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: search-bot-frontend
    ports:
      - "${FRONTEND_PORT:-20002}:20002"
    environment:
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:30547}
    depends_on:
      - search-bot-backend
    restart: unless-stopped
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/index.html:/app/index.html
    networks:
      - graphiti-network

  minio:
    image: minio/minio:latest
    container_name: graphiti-minio
    ports:
      - "${MINIO_API_PORT:-20734}:9000"      # MinIO API
      - "${MINIO_CONSOLE_PORT:-20735}:9001"  # MinIO Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-miniosecret}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - graphiti-network

  minio-init:
    image: minio/mc:latest
    container_name: graphiti-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set minio http://minio:9000 ${MINIO_ROOT_USER:-minio} ${MINIO_ROOT_PASSWORD:-miniosecret};
      mc mb minio/zoom-transcripts --ignore-existing;
      mc anonymous set public minio/zoom-transcripts;
      exit 0;
      "
    networks:
      - graphiti-network

networks:
  graphiti-network:
    driver: bridge

volumes:
  neo4j_data:
  neo4j_logs:
  minio_data: